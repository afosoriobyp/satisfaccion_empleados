{% extends 'base.html' %}

{% block body %}

<div class="card mb-4 bg-light" data-html2canvas-ignore="true">
    <div class="card-body py-3">
        <form action="/informe" method="GET" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">ðŸ“… Fecha Inicio:</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">ðŸ“… Fecha Fin:</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">Filtrar Resultados</button>
                <a href="/informe" class="btn btn-outline-secondary">Limpiar</a>
                <button type="button" onclick="generatePDF()" class="btn btn-danger">
                    ðŸ“„ PDF
                </button>
            </div>
        </form>
    </div>
</div>

<div id="export-content" class="p-3 bg-white">
    
    <div class="text-center mb-4">
        <h4>Reporte de Clima Laboral</h4>
        <p class="text-muted mb-0">
            Periodo: 
            {% if start_date %}Desde {{ start_date }}{% else %}Inicio{% endif %} 
            hasta 
            {% if end_date %}{{ end_date }}{% else %}Hoy{% endif %}
        </p>
        <small class="text-muted">Generado el: <span id="fecha-hoy"></span></small>
    </div>

    <div class="row mb-5">
        <div class="col">
            <div class="card text-white mb-3 h-100" style="background-color: #9370DB;">
                <div class="card-header text-center">Miedo ðŸ˜¨</div>
                <div class="card-body text-center">
                    <h2 class="card-title display-4">{{ stats.miedo }}</h2>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-white mb-3 h-100" style="background-color: #E74C3C;">
                <div class="card-header text-center">Furia ðŸ˜¡</div>
                <div class="card-body text-center">
                    <h2 class="card-title display-4">{{ stats.furia }}</h2>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-white mb-3 h-100" style="background-color: #3498DB;">
                <div class="card-header text-center">Tristeza ðŸ˜¢</div>
                <div class="card-body text-center">
                    <h2 class="card-title display-4">{{ stats.tristeza }}</h2>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-white mb-3 h-100" style="background-color: #2ECC71;">
                <div class="card-header text-center">Desagrado ðŸ¤¢</div>
                <div class="card-body text-center">
                    <h2 class="card-title display-4">{{ stats.desagrado }}</h2>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-white mb-3 h-100" style="background-color: #F1C40F;">
                <div class="card-header text-center">AlegrÃ­a ðŸ˜„</div>
                <div class="card-body text-center">
                    <h2 class="card-title display-4">{{ stats.alegria }}</h2>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <h4 class="mb-4 mt-4">AnÃ¡lisis de Causas (Diagrama de Ishikawa)</h4>
    
    <div class="ishikawa-container border p-4 bg-white position-relative" style="min-height: 500px;">
        <div class="position-absolute top-50 start-0 w-75 border-bottom border-5 border-dark"></div>
        <div class="position-absolute top-50 end-0 translate-middle-y bg-danger text-white p-3 rounded text-center" style="width: 22%; border: 2px solid #333;">
            <h6 class="m-0">BAJA<br>SATISFACCIÃ“N</h6>
        </div>

        <div class="row h-100">
            <div class="col-6 mb-4 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(45deg); top: 25px;"></div>
                <h6 class="text-center bg-danger text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem;">SOBRECARGA</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Sobrecarga %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-6 mb-4 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(-45deg); top: 25px;"></div>
                <h6 class="text-center bg-warning text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem;">RECONOCIMIENTO</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Reconocimiento %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-6 mb-4 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(45deg); top: 25px;"></div>
                <h6 class="text-center bg-info text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem;">COMUNICACIÃ“N</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Comunicacion %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-6 mb-4 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(-45deg); top: 25px;"></div>
                <h6 class="text-center bg-secondary text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem;">RECURSOS</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Recursos %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="w-100" style="height: 20px;"></div>
            <div class="col-6 mt-2 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(-45deg); bottom: 25px;"></div>
                <h6 class="text-center bg-success text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem;">AMBIENTE</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Ambiente %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-6 mt-2 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(45deg); bottom: 25px;"></div>
                <h6 class="text-center bg-dark text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem;">INSEGURIDAD</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Inseguridad %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-6 mt-2 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(-45deg); bottom: 25px;"></div>
                <h6 class="text-center text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem; background-color: #9370DB;">DESARROLLO</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Desarrollo %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-6 mt-2 position-relative" style="height: 180px;">
                <div class="border-start border-3 border-dark h-100 position-absolute start-50 translate-middle-x" style="transform: rotate(45deg); bottom: 25px;"></div>
                <h6 class="text-center text-white rounded p-1 mx-auto w-75 position-relative" style="z-index: 2; font-size: 0.85rem; background-color: #E67E22;">LIDERAZGO</h6>
                <ul class="list-group list-group-flush small mt-2 mx-auto w-75 bg-transparent">
                    {% for item in ishikawa.Liderazgo %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-danger" style="font-size: 0.75rem;">â€¢ {{ item }}</li>
                    {% else %}
                        <li class="list-group-item bg-transparent py-1 border-0 text-muted fst-italic">-</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    document.getElementById('fecha-hoy').innerText = new Date().toLocaleDateString();

    function generatePDF() {
        const element = document.getElementById('export-content');
        const opt = {
            margin:       0.3,
            filename:     'informe_filtrado_ishikawa.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, logging: true, useCORS: true },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
{% endblock %}